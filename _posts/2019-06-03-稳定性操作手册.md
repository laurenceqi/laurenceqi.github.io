---
layout: post
title: 稳定性操作手册
categories: [技术]
tags: [高可用]
---

## 思考切面

### 什么时候会挂？

- 外部原因

	- 流量

		- 性能问题

			- 压测

		- 流量突增

			- 限流
			- 快速扩容

	- 中间件

		- db

			- 慢查询

				- 每日巡检

			- 资源不足

				- db隔离

		- redis

			- 节点挂
			- 集群挂

				- 降级
				- 快速切换集群

			- 大key

				- sdk

			- 资源不足

				- 容量巡检
				- 资源隔离

		- mq

			- 节点挂
			- 集群挂

				- 降级
				- 快速切换集群

			- 容量不足

				- 容量巡检

		- es

			- 慢

				- 降级

			- 容量

		- job

			- 停止触发

				- 降级

		- 网关

	- 依赖的服务

		- 集群挂

			- 降级

		- RT长

			- 超时

				- 设置合理超时时间

		- 数据异常

			- 调用方做了Limit限制，truncate数据

		- 行为异常

	- 机器
	- 网络

- 内部原因

	- 变更

		- 代码变更

			- 业务需求
			- 技术改造
			- bugfix

		- 配置变更

			- 技术配置

				- pizza
				- huskar
				- stargate
				- appos
				- 资源收口

			- 业务配置

				- 一键回滚？
				- 分流规则
				- T规则

		- 隐藏风险

			- 异常路径
			- 资源泄漏

				- oom
				- 连接池耗光

			- 低频job

	- 性能
	- 数据

		- 脏数据

	- 人

		- 误操作

### 重要级别

- 关键路径

	- 定义
	- 列表

- 非关键路径

### 人员

- 新人
- 老人

### 流量入口

- web
- soa
- job

### 层次

- 意识
- 行为

### 挂的场景

- 搞挂自己
- 搞挂别人
- 被别人搞挂

### 分类

- 共性
- 特性

### 应用类型

- job
- 服务
- 离线

## 风险等级

### 1. 技术改造

### 2. bug fix

### 3. 业务需求

## 金字塔原理

### MECE 法則

- ME：相互獨立
- CE：完全窮盡

### 四個邏輯順序

- 時間順序

	- 按照事的發生先後順序進行問題分析

- 空間順序

	- 結構分類

		- 如地域：美國﹑中國等
		- 如部門：研發部﹑市場部等

- 類型順序

	- 類別分類

- 重要性順序

	- 依據事的輕重緩急

		- 如：老弱病殘
		- 如：女士優先

## 组织保障

### 虚拟组织

### KPI

## 事故处理

### 时间顺序

- 事故前

	- 监控

		- 全局面板

			- 面板标准

	- 报警

		- 报警配置标准

	- 日常巡检

		- 巡检内容
		- 巡检标准
		- 巡检SOP

	- 业务预警
	- 值班

		- 值班内容
		- 值班SOP

- 事故中

	- 人给力

		- SRE虚拟组织

			- 组织目标

				- 保证组内系统SLA，达成稳定性0事故目标

			- 组织工作内容

				- 稳定性规划与实施

					- 培训
					- 演练
					- 快速定位问题
					- choasmonkey
					- 工具使用
					- 确定影响范围
					- 及时升级
					- 沟通与决策

				- Monitoring
				- Oncall
				- Firefighting

			- 组织形式

				- 选拔制，选拔拔尖同学参与
				- 虚拟组织

			- 考核与奖励

	- 有工具

		- 熟练使用各种工具

	- 有准备

		- 预案SOP

			- 开关
			- 回滚
			- 重启
			- 限流
			- 切机房
			- 降级
			- 梳理
			- 剔除节点

		- 确保SOP可用？

			- 演练

- 事故后

	- 复盘
	- 改进
	- 更新流程

### 空间顺序

- 在公司
- 不在公司

	- 路上
	- 家里

- 值班机制

### 类型顺序

## 事故防范

### 外部原因

- 压测
- 巡检

	- 容量
	- 异常

		- 慢Sql

- 隔离
- 切换

	- 演练

- 应用降级

### 内部原因

- 变更风险控制

	- 变更时间顺序

		- 需求分析

			- 稳定性做精意味着吞吐的下降，所以要提高需求质量

				- 项目的价值是什么？是否可衡量、可复盘
				- 项目方案的设计能不能达成项目目标？
				- 方案是否合理，是否够简单，直击问题本质，可扩展

		- 技术方案

			- checklist

				- 需求部分

					- 需求分析与模块拆解
					- 技术改造需求背景及目标
					- 关键设计

						- 流程图、状态机
						- 设计模式
						- 核心模型抽象

					- 表结构
					- 与外部的交互流程

						- 接口
						- 排期
						- 性能
						- 异常
						- 降级
						- 服务端接口限制

							- 返回个数限制

					- 业务异常流程

						- 别人异常
						- 自己异常
						- 幂等
						- 补偿

					- 安全

						- 功能权限
						- 数据权限
						- csrf
						- sql注入

				- 技术部分

					- 上线方案、回滚方案、灰度方案
					- 容量

						- 是否压测

					- 监控、日志、埋点
					- 异常处理

						- 降级
						- 兜底

					- 变更风险评估说明
					- 多活设计
					- 是否影响现有SOP

			- 保证执行？

				- 每个需求都要写技术方案文档
				- review

					- peer review
					- group review
					- leader review

		- 编码

			- 单元测试进行自测

		- code review

			- gitlab+IDE
			- checklist

				- code style
				- 单元测试覆盖情况

					- 未覆盖关键场景要覆盖

				- 是否follow 技术方案

					- 灰度代码是否ok
					- 对关键路径的影响

				- 可读性

					- clean code

			- 目的

				- education
				- maintaining norms
				- gatekeeping
				- accident prevention

			- 执行保证？

				- code review通过才能提测
				- 不通过要进行修改
				- 所以code review要提测前尽早开始
				- 排期时候指定reviewer，review排期

					- 高风险变更必须经过leader review

		- 测试用例评审

			- 产品研发测试都要参与
			- 尽早进行，三方需求理解达成一致
			- 异常流程case
			- 压测

		- 测试
		- 发布

			- 发布SOP

				- 高风险变更单机房过午高峰
				- 新人
				- 权限

			- double check

				- 代码review后变更
				- 发布计划
				- 回滚计划
				- 灰度方案

			- 灰度

				- 一定要有灰度

					- 产品灰度
					- 技术灰度

				- 灰度方案经过测试环境测试
				- 灰度结束代码清理

					- 统一灰度模块？

				- 单机房灰度

			- 压测

	- 变更空间顺序

		- 环境

			- 环境部署规范

		- 代码

			- 分支规范

	- 变更类型

		- 代码变更
		- 配置变更

			- review流程
			- 双人double check

	- 变更风险级别

		- 高危

			- 技术改造
			- 对关键路径有影响

		- 中危
		- 低危

*XMind: ZEN - Trial Version*