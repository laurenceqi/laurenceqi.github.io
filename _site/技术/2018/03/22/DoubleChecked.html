<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Double-checked Lock 到底有什么问题？ &middot; Laurence
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Laurence
        </a>
      </h1>
      <p class="lead">读书、思考</p>
    </div>

    <nav class="sidebar-nav">
<!--       <a class="sidebar-nav-item" href="/">Home</a>
 -->
      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/">Index</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/tags.html">Tags</a>
          
        
      

    </nav>
 
    <p>&copy; 2018. laurence 版权所有. <br>
<span id="busuanzi_container_site_pv">
    PV: <span id="busuanzi_value_site_pv"></span>
    </span> &nbsp;&nbsp;&nbsp;&nbsp; 
    <span id="busuanzi_container_site_uv">
    UV: <span id="busuanzi_value_site_uv"></span>
    </span>

    </p>

    <p style="">
    </p>
  </div>
</div>


    <div class="content container">
      	<div class="post">
  <h1 class="post-title">Double-checked Lock 到底有什么问题？</h1>
  <span class="post-date">22 Mar 2018&nbsp;&nbsp;&nbsp;&nbsp; <span id="busuanzi_container_page_pv">
  阅读次数<span id="busuanzi_value_page_pv"></span>
</span></span>
  
  <p>为了减少同步的开销，又想lazy initialize实例，所以一种”聪明“的做法出现了：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="c1">// double-checked-locking - don't do this!</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">Something</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">Something</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Something</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
<span class="o">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>但是，<strong>这并不总是正确工作</strong>。</p>

<h3 id="原因一">原因一</h3>
<p>当线程 A 执行到第 9 行时，会执行实例的创建、初始化及赋值，如果此时线程 B 执行到第 6 行，读取 instance 对象的值，因为该步骤不存在任何 happens before 关系， 所以可能读到指令重排序后的值。如果重排序后，指令顺序是：</p>

<ol>
  <li>线程 A 创建 Something 对象实例 S</li>
  <li>线程 A 将 S 的引用赋值给 instance 对象</li>
  <li>线程 B 读取 instance 对象不为 null， 并返回引用</li>
  <li>线程 A 初始化instance对象</li>
</ol>

<p>该种情况下，就会返回一个没有初始化的实例，导致程序运行错误。</p>

<p>重排序后的字节码可能是这样：</p>

<figure class="highlight"><pre><code class="language-assembly" data-lang="assembly">0206106A   mov         eax,0F97E78h
0206106F   call        01F6B210                  ; allocate space for
                                                 ; Singleton, return result in eax
02061074   mov         dword ptr [ebp],eax       ; EBP is &amp;singletons[i].reference 
                                                 ; store the unconstructed object here.
02061077   mov         ecx,dword ptr [eax]       ; dereference the handle to
                                                 ; get the raw pointer
02061079   mov         dword ptr [ecx],100h      ; Next 4 lines are
0206107F   mov         dword ptr [ecx+4],200h    ; Singleton's inlined constructor
02061086   mov         dword ptr [ecx+8],400h
0206108D   mov         dword ptr [ecx+0Ch],0F84030h</code></pre></figure>

<p>&amp;singletons[i].reference 对引用的赋值早于构造函数。</p>

<h3 id="原因二">原因二</h3>
<p>即使上述步骤中第6行读到了实例变量都赋值的实例 S， S的引用类型实例变量所指向的对象有可能也是状态不对的。所以返回的实例仍然存在问题。比如:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Something</span> <span class="o">{</span>
	<span class="n">Something</span>  <span class="n">a</span><span class="o">,</span>
	<span class="n">Something1</span> <span class="n">b</span><span class="o">,</span>
<span class="o">}</span></code></pre></figure>

<p>即使实例S的实例变量a != null, b != null, a,b所指向的对象仍有可能是未初始化完全的。</p>

<h3 id="正确做法">正确做法</h3>
<p>在老的Java内存模型定义下，并没有好的办法来解决Double checked问题，但可以通过 On Demand Holder 类来解决。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LazySomethingHolder</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Something</span> <span class="n">something</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Something</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Something</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">LazySomethingHolder</span><span class="o">.</span><span class="na">something</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>在新的内存模型定义下，则可以通过 Volatile 关键字来解决。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">Something</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Something</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Something</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>为什么使用 volatile 关键词就可以解决该问题呢？</p>

<h3 id="引用">引用</h3>

<ol>
  <li><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html">http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html</a></li>
  <li><a href="https://www.javaworld.com/article/2074979/java-concurrency/double-checked-locking--clever--but-broken.html?page=2">https://www.javaworld.com/article/2074979/java-concurrency/double-checked-locking–clever–but-broken.html?page=2</a></li>
</ol>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/%E6%8A%80%E6%9C%AF/2018/03/22/JMM2.html">
            你应该知道的Java内存模型（二）
            <small>22 Mar 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/%E6%8A%80%E6%9C%AF/2018/03/21/JMM.html">
            你应该知道的Java内存模型（一）
            <small>21 Mar 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/%E8%AF%BB%E4%B9%A6/2018/03/20/%E5%8E%9F%E5%88%99-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">
            《原则》读书笔记
            <small>20 Mar 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://laurenceqi.me/%E6%8A%80%E6%9C%AF/2018/03/22/DoubleChecked.html";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = "/%E6%8A%80%E6%9C%AF/2018/03/22/DoubleChecked"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://laurenceqi.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            

    </div>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>
  </body>
</html>
